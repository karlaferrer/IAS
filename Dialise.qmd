---
title: " Fatores prognósicos para a sobrevivência pacientes idosos em hemodiálise na Áustria"
author: "**Karla de Araujo Ferreira**"
lang: pt
format:
    pdf: default
    html: 
      self-contained: true
csl: epidemiology.csl
bibliography: references.bib
---

**Programa de Pós-Graduação Stricto-Sensu em Epidemiologia em Saúde Pública, Escola Nacional de Saúde Pública Sergio Arouca, Fundação Oswaldo Cruz. Rio de Janeiro, fevereiro de 2023.**

**Disciplina: Introdução à Análise de Sobrevivência - 2023**

\newpage

```{r pacotes, include=FALSE, message=FALSE, warning=FALSE}
#instalar e carregar pacotes
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  here, #caminho do projeto
  readxl, #ler arquivo excel
  tableone, #fazer tabela 1
  kableExtra,#renderizar tabela
  knitr, #renderizar tabela
  survival, #analise de sobrevivencia
  survminer,#plotar graficos KM
  ggsurvfit,
  gtsummary, # tabela OR e IC 
  tidycmprsk, 
  condsurv,
  patchwork, #compor graficos ggplot
  finalfit, #checar dados faltantes
  tidyverse,
  ResourceSelection, #qualidade do ajuste
  ggplot2,
  gridExtra, # forest plot OR e IC 
  equatiomatic #escrever equacoes 
  )

```

```{r banco, include=FALSE, message=FALSE, warning=FALSE}
# 0. Leitura do banco de dados

#ler banco de dados
data<-readxl::read_excel(here::here("data.xlsx"), sheet = "publicData")
#estrutura do banco
str(data)

```

```{r organiza, include=FALSE, message=FALSE, warning=FALSE}
#1. Organizar banco
#transformar covariaveis em fator e idade em valor 
data<-cbind(lapply(data[,1:10],as.factor), (data[,11:13]))
data$idade<-round(data$age10*10,0)

str(data)

#Apenas pacientes em dialise
data<-subset(data,dialysis == 1)

```

```{r tab1,include=FALSE, message=FALSE, warning=FALSE}
#2. Análise exploratória
# Tabela 1

#normalidade - idade
hist(data$idade)
#nao e normalmente distribuida

tab1 <- tableone::CreateTableOne(vars = c("Gender","DM","hypert",
                                "heart","","neoplasia",
                                "liver","vascular","COPD",
                                "idade"), 
                                strata = "dead",test = TRUE,                                       includeNA = TRUE, data = data)

tabela1<-print (tab1, showAllLevels = TRUE,nonnormal = "idade")

tabela1<-tabela1[,1:3]

tabela1[,1]<-ifelse(tabela1[,1] == "0", "Não", tabela1[,1] )
tabela1[,1]<-ifelse(tabela1[,1] == "1", "Sim", tabela1[,1] )

tabela1<- as.data.frame(tabela1)

tabela1$variav<-c("N","Sexo(%)","",
                      "Diabetes mellitus (%)","","Hipertensão (%)",
                      "","Doença coração(%)","",
                      "Neoplasia (%)", "","Doença hepática (%)",
                      "","Doença vascular (%)", "",
                      "DPOC (%)", "", "Idade (mediana [IQR])")


tabela1<-data.frame(tabela1[,c(4,1,2,3)])

colnames(tabela1)<-c("Característica","", "Não óbito", "Óbito")

rownames(tabela1) <- NULL
```

```{r Tabela1}
#| label: tbl-Tabela1
#| tbl-cap: "Características da coorte de idosos que iniciaram hemodiálise entre 2002 e 2009, segundo status (óbito)."
#| warning: false
#| echo: false
#| message: false

kbl(tabela1, align = "lcccc") %>%
kable_classic(full_width = F) %>%
footnote(symbol = "DPOC: Doença pulmonar obstrutiva crônica"
)
```

\newpage

**Estimacao não paramétrica - Kaplan-Meier global**

```{r KMglobal, include=TRUE, echo = FALSE, message=FALSE, warning=FALSE}
#3. Estimacao nao parametrica - Kaplan-Meier global
#Status nao pode ser fator!
data$dead<-as.numeric(data$dead)

#Objeto surival
y <- survival::Surv(data$Time_to_Event*12, data$dead)

#Kaplan-Meier plot
survfit2(y ~ 1, data = data) %>% 
  ggsurvfit() +
  labs(
    x = "Anos",
    y = "Probabilidade de sobrevivência"
  ) +
  add_confidence_interval() +
  add_risktable() 

```

```{r mediana, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
#3.1 Mediana

#Probabilidde de sobreviver pelo menos 1, 2, ..., 8 anos
summary(survfit(y ~ 1, data = data), times = c(1:8))
#ou
#survfit(Surv(Time_to_Event, dead) ~ 1, data = data) %>% 
#  gtsummary::tbl_survfit(
#    times = c(1,2,3,4,5),
#    label_header = "**survival (95% CI)**"
# )

#Mediana = 2.24 anos (2.15,2.33)
survfit(Surv(Time_to_Event, dead) ~ 1, data = data)
```

\newpage

**Estimacao nao parametrica - Kaplan-Meier com estratificacao**

```{r KMestrat, include= TRUE, echo = FALSE, message=FALSE, warning=FALSE }
#4. Estimacao nao parametrica - Kaplan-Meier com estratificacao
#Kaplan-Meier plot - estratificado
#Sexo

splots <- list()
splots[[1]] <- ggsurvplot(survfit(y ~ Gender, data = data), data = data,conf.int=F, pval=TRUE, risk.table= FALSE, 
           legend.labs=c("F", "M"), legend.title="Sexo",  
           ggtheme = theme_minimal(),
           xlab = "Anos", ylab = "S(t)") 

#DM
splots[[2]] <- ggsurvplot(survfit(y ~ DM, data = data), data = data,conf.int=F, pval=TRUE, risk.table= FALSE, 
           legend.labs=c("Não", "Sim"), legend.title="Diabetes mellitus",  
           ggtheme = theme_minimal(),
           xlab = "Anos", ylab = "S(t)") 

#Hipertensao
splots[[3]] <- ggsurvplot(survfit(y ~ hypert, data = data), data = data,conf.int=F, pval=TRUE, risk.table= FALSE, 
           legend.labs=c("Não", "Sim"), legend.title="Hipertensão",  
           ggtheme = theme_minimal(),
           xlab = "Anos", ylab = "S(t)") 
#Coracao
splots[[4]] <- ggsurvplot(survfit(y ~ heart, data = data), data = data,conf.int=F, pval=TRUE, risk.table= FALSE, 
           legend.labs=c("Não", "Sim"), legend.title="Doença coração",  
           ggtheme = theme_minimal(),
           xlab = "Anos", ylab = "S(t)") 

#Neoplasia
splots[[5]] <- ggsurvplot(survfit(y ~ neoplasia, data = data), data = data,conf.int=F, pval=TRUE, risk.table= FALSE, 
           legend.labs=c("Não", "Sim"), legend.title="Neoplasia",  
           ggtheme = theme_minimal(),
           xlab = "Anos", ylab = "S(t)") 
 
#Figado
splots[[6]] <- ggsurvplot(survfit(y ~ liver, data = data), data = data,conf.int=F, pval=TRUE, risk.table= FALSE, 
           legend.labs=c("Não", "Sim"), legend.title="Doença hepática",  
           ggtheme = theme_minimal(),
           xlab = "Anos", ylab = "S(t)") 

#Vascular
splots[[7]] <- ggsurvplot(survfit(y ~ vascular, data = data), data = data,conf.int=F, pval=TRUE, risk.table= FALSE, 
           legend.labs=c("Não", "Sim"), legend.title=" Doença vascular",  
           ggtheme = theme_minimal(),
           xlab = "Anos", ylab = "S(t)") 

#DPOC
splots[[8]] <- ggsurvplot(survfit(y ~ COPD, data = data), data = data,conf.int=F, pval=TRUE, risk.table= FALSE, 
           legend.labs=c("Não", "Sim"), legend.title=" DPOC",  
           ggtheme = theme_minimal(),
           xlab = "Anos", ylab = "S(t)") 

# Arrange multiple ggsurvplots and print the output
arrange_ggsurvplots(splots, print = TRUE, ncol = 1, nrow = 1)

```

```{r logrank, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
#4.1 Comparando grupos - Log-rank
#Sexo
survdiff(y ~ Gender, data = data)
#Não há diferença 

#DM
survdiff(y ~ DM, data = data)
#Diferença significativa p= 0.04

#Hipertensao
survdiff(y ~ hypert, data = data)
#Diferença significativa p= <2e-16 

#Coraçao
survdiff(y ~ heart, data = data)
#Não há diferença 

#Neoplasia
survdiff(y ~ neoplasia, data = data)
#Não há diferença 

#Figado
survdiff(y ~ liver, data = data)
##Diferença significativa p= 0.01

#Vascular
survdiff(y ~ vascular, data = data)
#Não há diferença 

#DPOC
survdiff(y ~ COPD, data = data)
#Diferença significativa p= 8e-04

```

```{r peto, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
#4.2 Comparando grupos - Peto
#maior peso no incio do seguimento
#Sexo
survdiff(y ~ Gender, data = data, rho=1)
#Não há diferença 

#DM
survdiff(y ~ DM, data = data, rho=1)
#Diferença significativa p= 0.04

#Hipertensao
survdiff(y ~ hypert, data = data, rho=1)
#Diferença significativa p= <2e-16 

#Coraçao
survdiff(y ~ heart, data = data, rho=1)
#Não há diferença 

#Neoplasia
survdiff(y ~ neoplasia, data = data, rho=1)
#Não há diferença 

#Figado
survdiff(y ~ liver, data = data, rho=1)
##Diferença significativa p= 0.01

#Vascular
survdiff(y ~ vascular, data = data, rho=1)
#Não há diferença 

#DPOC
survdiff(y ~ COPD, data = data, rho=1)
#Diferença significativa p= 8e-04

```

```{r Cox_simples, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
#5. Modelos semi-parametricos simples - Cox
#Efeito isolado de cada covariavel sobre o tempo de sobrevivencia
#significancia p < 0.2

#Sexo
coxph(y ~ Gender, data = data) %>%
tbl_regression(exp = TRUE) 
#nao signifitiva

#Idade
coxph(y ~ idade, data = data) %>%
tbl_regression(exp = TRUE) 
#nao signifitiva


#DM
cox_dm <- coxph(y ~ DM, data = data) %>%
tbl_regression(exp = TRUE) 
#signifitiva

#hipertensao
coxph(y ~ hypert, data = data) %>%
tbl_regression(exp = TRUE) 
#signifitiva

#Coracao
coxph(y ~ heart, data = data) %>%
tbl_regression(exp = TRUE) 
#nao signifitiva

#Neoplasia
coxph(y ~ neoplasia, data = data) %>%
tbl_regression(exp = TRUE) 
#nao signifitiva

#Figado
coxph(y ~ liver, data = data) %>%
tbl_regression(exp = TRUE) 
#signifitiva

#Vascular
coxph(y ~ vascular, data = data) %>%
tbl_regression(exp = TRUE) 
#signifitiva p < 0.122

#DPOC
coxph(y ~ COPD, data = data) %>%
tbl_regression(exp = TRUE) 
#signifitiva

#os modelos de Cox simples confirmam a analise grafica e teste log-rak e peto

```

\newpage

**Modelo semi-parametrico multiplo - Cox**

```{r cox_multiplo, include= TRUE, echo = TRUE, message=FALSE, warning=FALSE}
#6. Modelo semi-parametrico multiplo - Cox
#Efeitos ajustados das covariaveis sobre o tempo de sobrevivencia


m1<- coxph(y ~ Gender + idade, x= TRUE, data = data) 
m2<- coxph(y ~ Gender + idade + DM, x= TRUE, data = data) 
m3<- coxph(y ~ Gender + idade + DM + hypert, x= TRUE, data = data) 
m4<- coxph(y ~ Gender + idade + DM + hypert + liver, x= TRUE, data = data)
m5<- coxph(y ~ Gender + idade + DM + hypert + liver + vascular, x= TRUE, 
           data = data)
m6<- coxph(y ~ Gender + idade + DM + hypert + liver + vascular + COPD, 
           x= TRUE, data = data) 

anova(m1, m2, m3, m4, m5, m6)

summary(m6)

```
\newpage

**Resultados do modelo ajustado**

```{r res_mult, include= TRUE, echo = FALSE, message=FALSE, warning=FALSE}
#6.1 Resultados do modelo ajustado

m6 %>%
tbl_regression(exp = TRUE) 

```

```{r prognostico, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
#6.2 Indice prognostico

source("Rfun.r")
#par(mfrow = c(2,2))
plot.pi(m3, main = "Modelo 3" )
plot.pi(m4, main = "Modelo 4" )
plot.pi(m5, main = "Modelo 5" )
plot.pi(m6, main = "Modelo 6" )

```
\newpage

**Analise de Residuos**

```{r shoenfeld, include= TRUE, echo = FALSE, message=FALSE, warning=FALSE}
#7.1 Analise de residuos

#Proporcionalidade - Shoenfeld
res.sho <- cox.zph(m6)
plot(res.sho, xlab = "Anos", col= c("red", "blue"))
abline(h=0, col="grey")

plot(res.sho, xlab = "Anos", col= c("red", "blue"), resid = FALSE)
abline(h=0, col="grey")

res.sho

#outra opcao grafica
#ggcoxzph(res, font.x = 10, font.y=10, main = "")
#Ref http://www.sthda.com/english/wiki/cox-model-assumptions

```

```{r martingale, include= TRUE, echo = FALSE, message=FALSE, warning=FALSE}

#log-linearidade - Martingale

# Analisando a forma funcional através do gráfico dos resíduos de Martingale x idade
#grafico do residuo Martingale no modelo nulo x idade

mod0 <- coxph(y ~ 1, data = data, x = T)
summary(mod0)
mod0.mar <- resid(mod0, type= 'martingale')
plot (data$idade, mod0.mar, xlab = "Idade", ylab = "Resíduos martingale",
main= "Avaliação da
forma funcional da Idade", lwd=1, col= "grey" )
lines(lowess(data$idade, mod0.mar, iter = 0), lty = 2)
#Não há associação entre o tempo de sobrevivência e a idade, uma vez que não há 
#tendência linear e o lowess está em torno do zero.

#outra forma
ggcoxfunctional(Surv(Time_to_Event, dead) ~ idade, data = data,
                ggtheme = theme_minimal())

```

```{r rdeviance, include= TRUE, echo = FALSE, message=FALSE, warning=FALSE}

# atípicos - Residuos deviance
res.dev <-resid(m6, type = "deviance")
plot(res.dev, col= "grey", ylab = "Resíduos deviance", xlab = "Índice")
abline(h=0, col="red")

#Verifica-se grande quantidade de observacoes atipicas - 6.3%
#(sum(res.dev  > 2) + sum(res.dev  < (-2)))/length(data$ID)

#outra forma
ggcoxdiagnostics(m6, type = "deviance",
                 linear.predictions = FALSE, sline = FALSE, ggtheme = theme_minimal(),
                 ylab = "Resíduos deviance",
                 xlab = "Índice"
                 )

```

```{r rescore, include= TRUE, echo = FALSE, message=FALSE, warning=FALSE}
#influentes - Residuos escore
res.esc <- resid(m6, type= 'dfbetas')
par(mfrow = c(1,2))
plot (data$Gender , res.esc[,1],xlab = "Sexo", ylab = "Resíduos escore")
plot (data$idade , res.esc[,2],xlab = "Idade", ylab = "Resíduos escore")
plot (data$DM , res.esc[,3],xlab = "DM", ylab = "Resíduos escore")
plot (data$hypert , res.esc[,4],xlab = "Hipertensão", ylab = "Resíduos escore")
plot (data$liver , res.esc[,5],xlab = "D. hepática", ylab = "Resíduos escore")
plot (data$vascular , res.esc[,6],xlab = "D. vascular", ylab = "Resíduos escore")
plot (data$COPD , res.esc[,7],xlab = "DPOC", ylab = "Resíduos escore")

#outra forma 
ggcoxdiagnostics(m6, type = "dfbeta",
                 linear.predictions = FALSE,
                 sline = FALSE,
                 ylab = "Resíduos dfbeta",
                 xlab = "Índice",
                 ggtheme = theme_minimal())

```
```{r mod_7}
#constatada a nao proporcionalidade para hipertensao
#o modelo sera estratificado por essa variavel

m7<- coxph(y ~ Gender + idade + DM + hypert + liver + vascular + COPD 
           + strata (hypert), 
           x= TRUE, data = data) 

summary(m7)

#plot.pi(m7, main = "Modelo 7" )
#o indice prognistico nao funciona aqui

```
```{r}

#7.1 Analise de residuos

#Proporcionalidade - Shoenfeld
res.sho <- cox.zph(m7)
plot(res.sho, xlab = "Anos", col= c("red", "blue"))
abline(h=0, col="grey")

plot(res.sho, xlab = "Anos", col= c("red", "blue"), resid = FALSE)
abline(h=0, col="grey")

res.sho

#outra opcao grafica
ggcoxzph(res.sho, font.x = 10, font.y=10, main = "")
#Ref http://www.sthda.com/english/wiki/cox-model-assumptions

```

**1. Introdução**

Descrever sucintamente o problema analisado, objetivo e as vari aveis escolhidas para a
analise.

A doença renal crônica evolui com a idade. 
Definição de estágio final da DRC
A entrada na diálise e o tempo de sobrevivência

Os estudos co pacientes idosos em terapia renal substitutiva devem levar em consideração a expectativa de vida restante do paciente, que usualmente é limitado pela presença de comorbidades, como diabetes, hipertensão, doença vascular, doença do coração etc. O objetivo desse trabalho foi investigar o efeito das comorbidades sobre o tempo de sobrevivência de pacientes com doença renal crônica em estágio 5 que iniciaram hemodiálise a partir dos 65 anos de idade com base em dados de sistema de informação sobre diálise e transplante austríaco.  

**2. Métodos**

Os dados analisados neste trabalho são provenientes de um estudo austríaco publicado na Revista PLoS ONE em 2017 intitulado "*Survival analysis of conservative vs. dialysis
treatment of elderly patients with CKD stage 5* e encontram-se disponíveis na página eletrônica da revista [ artigo; dados]. Esses dados foram originalmente obtidos a partir do registro de diálise e transplante austríaco - *Austrian Dialysis and Transplant Registry (OEDTR) - que identificou 8.622 pacientes incidentes de hemodiálise com idade igual o superior a 65 anos no período de janeiro de 2002 a dezembro de 2009.

O desfecho no estudo é o tempo em meses desde o início da hemodiálise até o óbito. As covariáveis analisadas se referem às comorbidades dos pacientes são: Diabetes mellitus (DM), hipertensão arterial (HA), doença do coração, neoplasia, doença hepática, doença vascular e doença pulmonar obstrutiva crônica (DPOC). Tratam-se todas de variáveis dicotômicas, ou seja, estão presentes ou ausentes (sim e não) e não tempo-dependentes. Também foram analisados os efeitos da idade e do sexo sobre o tempo de sobrevivência.

Para estimar o efeito dessas covariáveis sobre o tempo de sobrevivência dos idosos em hemodiálise, foi ajustado um modelo de risco proporcionais de Cox que é definido como um modelo semiparamétrico, pois assume uma forma paramétrica para o efeito das covariáveis e uma não paramétrica para a função de risco basal [marilia].

Incialmente  as covariáveis foram analisadas quanto à distribuição das frequências absolutas e relativas segundo o evento de interesse, óbito. Utilizou-se modelo não paramétrico de Kaplan-Meier para avaliar a sobrevida global dos pacientes e a sobrevida de acordo com a presença de cada comorbidade.  Essa análise incial permitiu explorar o efeito das covariáveis sobre o tempo de sobrevivência em hemodiálise, bem como avaliar de modo preliminar a premissa de proporcionalidade dos riscos do modelo de Cox.

O processo de modelagem foi realizado basicamente em três etapas descritas a seguir:

1. Obtenção das estimativas dos efeitos brutos de cada covariável sobre o tempo de sobrevivência dos pacientes com modelos de Cox simples. As variáveis candidatas ao modelo múltiplo foram aquelas que apresentaram significância ao nível de 1% (valor-p \<0,1), no teste de Wald para os coeficientes desses modelos.

2. O modelo de regressão de Cox foi elaborado comparando-se modelos aninhados com teste da razão de verossimilhança para verificar se a inclusão de uma ou mais covariáveis aumentavam de modo significativo a verossimilhança de um modelo em relação ao anterior, com menos variáveis (Anova tipo I). O nível de significância adototado foi de 5% (valor-p \<0,5). No primeiro modelo foram incluídas conjuntamente sexo e idade e em seguida nos demais, cada uma das comorbidades na seguinte ordem: Não foi verificado o efeito da interação de covariáveis.

3.  A qualidade de ajuste do modelo final foi avaliada segundo o teste Hosmer e Lemeshow e gráfico correspondente(11). Nesse teste, p-valores maiores que 0,05 indicam uma boa qualidade de ajuste do modelo. A avaliação dos pressupostos de lineariaride e independência foi realizada mediante disposição gráfica dos resíduos deviance.






