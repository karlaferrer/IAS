---
title: "Análise de sobrevivência de idosos portadores de doença renal crônica em hemodiálise: estudo restrospectivo com dados do Registro de Diálise e Transplante Austríaco"
author: "**Karla de Araujo Ferreira**"
lang: pt
format:
    pdf: default
    html: 
      self-contained: true
csl: epidemiology.csl
bibliography: references.bib
---

**Programa de Pós-Graduação Stricto-Sensu em Epidemiologia em Saúde Pública, Escola Nacional de Saúde Pública Sergio Arouca, Fundação Oswaldo Cruz. Rio de Janeiro, fevereiro de 2023.**

**Disciplina: Introdução à Análise de Sobrevivência - 2023**

\newpage

```{r pacotes, include=FALSE, message=FALSE, warning=FALSE}
#instalar e carregar pacotes
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  here, #caminho do projeto
  readxl, #ler arquivo excel
  tableone, #fazer tabela 1
  kableExtra,#renderizar tabela
  knitr, #renderizar tabela
  survival, #analise de sobrevivencia
  lubridate,
  ggsurvfit,
  gtsummary, # tabela OR e IC 
  tidycmprsk, 
  condsurv,
  patchwork, #compor graficos ggplot
  finalfit, #checar dados faltantes
  tidyverse,
  ResourceSelection, #qualidade do ajuste
  ggplot2,
  gridExtra, # forest plot OR e IC 
  equatiomatic #escrever equacoes 
  )

```

```{r banco, include=FALSE, message=FALSE, warning=FALSE}
# 0. Leitura do banco de dados

#ler banco de dados
data<-readxl::read_excel(here::here("data.xlsx"), sheet = "publicData")
#estrutura do banco
str(data)

```

```{r organiza, include=FALSE, message=FALSE, warning=FALSE}
#1. Organizar banco
#transformar covariaveis em fator e idade em valor 
data<-cbind(lapply(data[,1:10],as.factor), (data[,11:13]))
data$idade<-round(data$age10*10,0)

str(data)

#Apenas pacientes em dialise
data<-subset(data,dialysis == 1 )


```

```{r tab1,include=FALSE, message=FALSE, warning=FALSE}
#Análise exploratória
# Tabela 1

#normalidade - idade
hist(data$idade)
#nao e normalmente distribuida

tab1 <- tableone::CreateTableOne(vars = c("Gender","DM","hypert",
                                "heart","","neoplasia",
                                "liver","vascular","COPD",
                                "idade"), 
                                strata = "dead",test = TRUE,                                       includeNA = TRUE, data = data)

tabela1<-print (tab1, showAllLevels = TRUE,nonnormal = "idade")

tabela1<-tabela1[,1:3]

tabela1[,1]<-ifelse(tabela1[,1] == "0", "Não", tabela1[,1] )
tabela1[,1]<-ifelse(tabela1[,1] == "1", "Sim", tabela1[,1] )

tabela1<- as.data.frame(tabela1)

tabela1$variav<-c("N","Sexo(%)","",
                      "Diabetes mellitus (%)","","Hipertensão (%)",
                      "","Doença coração(%)","",
                      "Neoplasia (%)", "","Doença hepática (%)",
                      "","Doença vascular (%)", "",
                      "DPOC (%)", "", "Idade (mediana [IQR])")


tabela1<-data.frame(tabela1[,c(4,1,2,3)])

colnames(tabela1)<-c("Característica","", "Não óbito", "Óbito")

rownames(tabela1) <- NULL
```


```{r Tabela1}
#| label: tbl-Tabela1
#| tbl-cap: "Características da coorte de idosos que iniciaram hemodiálise entre 2002 e 2009, segundo status (óbito)."
#| warning: false
#| echo: false
#| message: false

kbl(tabela1, align = "lcccc") %>%
kable_classic(full_width = F) %>%
footnote(symbol = "DPOC: Doença pulmonar obstrutiva crônica"
)
```

\newpage


```{r KMglobal}
#Status nao pode ser fator!
data$dead<-as.numeric(data$dead)

#Objeto surival
y <- survival::Surv(data$Time_to_Event, data$dead)

#Kaplan-Meier plot
survfit2(y ~ 1, data = data) %>% 
  ggsurvfit() +
  labs(
    x = "Anos",
    y = "Probabilidade de sobrevivência"
  ) +
  add_confidence_interval() +
 add_risktable()

```

```{r}
#Probabilidde de sobreviver pelo menos 1, 2, ..., 5 anos
summary(survfit(y ~ 1, data = data), times = c(1,2,3,4,5))
#ou
#survfit(Surv(Time_to_Event, dead) ~ 1, data = data) %>% 
#  gtsummary::tbl_survfit(
#    times = c(1,2,3,4,5),
#    label_header = "**survival (95% CI)**"
# )

#Mediana = 2.24 anos (2.15,2.33)
survfit(Surv(Time_to_Event, dead) ~ 1, data = data)
```


```{r KMestrat}

#Kaplan-Meier plot - estratificado
#Sexo
g1 <- survfit2(y ~ Gender, data = data) %>% 
  ggsurvfit() +
  labs(
    x = "Anos",
    y = "S(t)",
    title = "Sexo"
  ) +
 add_confidence_interval() 

#DM
g2 <- survfit2(y ~ DM, data = data) %>% 
  ggsurvfit() +
  labs(
    x = "Anos",
    y = "S(t)",
    title = "DM"
  ) +
 add_confidence_interval() 

#Hipertensao
g3 <- survfit2(y ~ hypert, data = data) %>% 
  ggsurvfit() +
  labs(
    x = "Anos",
    y = "S(t)",
    title = "HA"
  ) +
 add_confidence_interval() 

#Coracao
g4 <- survfit2(y ~ heart, data = data) %>% 
  ggsurvfit() +
  labs(
    x = "Anos",
    y = "S(t)",
    title = "D.coração"
  ) +
 add_confidence_interval() 

#Neoplasia
g5<- survfit2(y ~ neoplasia, data = data) %>% 
  ggsurvfit() +
  labs(
    x = "Anos",
    y = "S(t)",
    title = "Neoplasia"
  ) +
 add_confidence_interval() 


#Figado
g6 <- survfit2(y ~ liver, data = data) %>% 
  ggsurvfit() +
  labs(
    x = "Anos",
    y = "S(t)",
    title = "D. hepática"
  ) +
 add_confidence_interval() 

#Vascular
g7 <- survfit2(y ~ vascular, data = data) %>% 
  ggsurvfit() +
  labs(
    x = "Anos",
    y = "S(t)",
    title = "D. vascular"
  ) +
 add_confidence_interval() 


#DPOC
g8 <- survfit2(y ~ COPD, data = data) %>% 
  ggsurvfit() +
  labs(
    x = "Anos",
    y = "S(t)",
    title = "DPOC"
  ) +
 add_confidence_interval() 


(g1 | g2) /
(g3 | g4) 

(g5 | g6) /
(g7 | g8)  

```


```{r logrank}
#Comparando grupos - Log-rank
#Sexo
survdiff(y ~ Gender, data = data)
#Não há diferença 

#DM
survdiff(y ~ DM, data = data)
#Diferença significativa p= 0.04

#Hipertensao
survdiff(y ~ hypert, data = data)
#Diferença significativa p= <2e-16 

#Coraçao
survdiff(y ~ heart, data = data)
#Não há diferença 

#Neoplasia
survdiff(y ~ neoplasia, data = data)
#Não há diferença 

#Figado
survdiff(y ~ liver, data = data)
##Diferença significativa p= 0.01

#Vascular
survdiff(y ~ vascular, data = data)
#Não há diferença 

#DPOC
survdiff(y ~ COPD, data = data)
#Diferença significativa p= 8e-04

```


```{r peto}
#Comparando grupos - Log-rank
#Sexo
survdiff(y ~ Gender, data = data, rho=1)
#Não há diferença 

#DM
survdiff(y ~ DM, data = data, rho=1)
#Diferença significativa p= 0.04

#Hipertensao
survdiff(y ~ hypert, data = data, rho=1)
#Diferença significativa p= <2e-16 

#Coraçao
survdiff(y ~ heart, data = data, rho=1)
#Não há diferença 

#Neoplasia
survdiff(y ~ neoplasia, data = data, rho=1)
#Não há diferença 

#Figado
survdiff(y ~ liver, data = data, rho=1)
##Diferença significativa p= 0.01

#Vascular
survdiff(y ~ vascular, data = data, rho=1)
#Não há diferença 

#DPOC
survdiff(y ~ COPD, data = data, rho=1)
#Diferença significativa p= 8e-04

```

```{r}
#modelagem parametrica
survreg(formula= Surv(Time_to_Event +1, dead)~1, data=data,
dist='exponential')

survreg(formula= Surv(Time_to_Event +1, dead)~1, data=data,
dist='weibull')



```



```{r Cox_simples}
#Sexo
coxph(y ~ Gender, data = data) %>%
tbl_regression(exp = TRUE) 
#nao signifitiva

#Idade
coxph(y ~ idade, data = data) %>%
tbl_regression(exp = TRUE) 
#nao signifitiva


#DM
cox_dm <- coxph(y ~ DM, data = data) %>%
tbl_regression(exp = TRUE) 
#signifitiva

#hipertensao
coxph(y ~ hypert, data = data) %>%
tbl_regression(exp = TRUE) 
#signifitiva

#Coracao
coxph(y ~ heart, data = data) %>%
tbl_regression(exp = TRUE) 
#nao signifitiva

#Neoplasia
coxph(y ~ neoplasia, data = data) %>%
tbl_regression(exp = TRUE) 
#nao signifitiva

#Figado
coxph(y ~ liver, data = data) %>%
tbl_regression(exp = TRUE) 
#signifitiva

#Vascular
coxph(y ~ vascular, data = data) %>%
tbl_regression(exp = TRUE) 
#nao signifitiva

#DPOC
coxph(y ~ COPD, data = data) %>%
tbl_regression(exp = TRUE) 
#signifitiva

#os modelos de Cox simples confirmam a analise grafica e teste log-rak e peto


```

```{r cox_multiplo}
m1<- coxph(y ~ Gender + idade, data = data) 
m2<- coxph(y ~ Gender + idade + DM, data = data) 
m3<- coxph(y ~ Gender + idade + DM + hypert, data = data) 
m4<- coxph(y ~ Gender + idade + DM + hypert + liver, data = data) 
m5<- coxph(y ~ Gender + idade + DM + hypert + liver + COPD, data = data) 

anova(m1,m2,m3,m4, m5)

```


```{r}

m5 %>%
tbl_regression(exp = TRUE) 

```
```{r}
tbl_regression(c(cox_sexo, cox_dm), exponentiate = TRUE)
```


