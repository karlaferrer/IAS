---
title: "Fatores prognósticos para a sobrevivência pacientes idosos em hemodiálise na Áustria"
author: "**Karla de Araujo Ferreira**"
lang: pt
format:
    pdf: default
    html: 
      self-contained: true
bibliography: 
  - references.bib
  - Packages.bib
csl: epidemiology.csl
---

**Disciplina: Introdução à Análise de Sobrevivência - 2023**

**Programa de Pós-Graduação Stricto-Sensu em Epidemiologia em Saúde Pública, Escola Nacional de Saúde Pública Sergio Arouca, Fundação Oswaldo Cruz.**

**Rio de Janeiro, março de 2023.**

```{r pacotes, include=FALSE, message=FALSE, warning=FALSE}
#instalar e carregar pacotes
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  here, #caminho do projeto
  readxl, #ler arquivo excel
  descr, #analise descritiva
  tableone, #fazer tabela 1
  kableExtra,#renderizar tabela
  knitr, #renderizar tabela
  survival, #analise de sobrevivencia
  survminer,#plotar graficos KM
  ggsurvfit, #graficos ggplot diagnostico
  gtsummary, # tabela OR e IC 
  tidycmprsk, 
  condsurv,
  finalfit, #tabelas dos modelos
  tidyverse,
  ResourceSelection, #qualidade do ajuste
  ggplot2,
  gridExtra, # forest plot OR e IC 
  )

```

```{r includ_biblio, include=FALSE, message=FALSE, warning=FALSE}
#knitr::write_bib(c(.packages(), "survival", "finalfit", "survminer", #"ggsurvfit"), "Packages.bib")
```

```{r banco, include=FALSE, message=FALSE, warning=FALSE}
# 0. Leitura do banco de dados

#ler banco de dados
data<-readxl::read_excel(here::here("data.xlsx"), sheet = "publicData")
#estrutura do banco
str(data)

```

```{r organiza, include=FALSE, message=FALSE, warning=FALSE}
#1. Organizar banco
#transformar covariaveis em fator e idade em valor 
data<-cbind(lapply(data[,1:10],as.factor), (data[,11:13]))
data$idade<-round(data$age10*10,0)
data$tempo<-data$Time_to_Event*12

str(data)

#Apenas pacientes em dialise
data<-subset(data,dialysis == 1)

```

```{r tab1,include=FALSE, message=FALSE, warning=FALSE}
#2. Análise exploratória

descr::freq(data$Gender) #frequencia por sexo
summary(data$idade) # descritiva idade

# Tabela 1

#normalidade - idade
hist(data$idade)
#nao e normalmente distribuida

tab1 <- tableone::CreateTableOne(vars = c("Gender","DM","hypert",
                                "heart","","neoplasia",
                                "liver","vascular","COPD",
                                "idade"), 
                                strata = "dead",test = TRUE,                                       includeNA = TRUE, data = data)

tabela1<-print (tab1, showAllLevels = TRUE,nonnormal = "idade")

tabela1<-tabela1[,1:3]

tabela1[,1]<-ifelse(tabela1[,1] == "0", "Não", tabela1[,1] )
tabela1[,1]<-ifelse(tabela1[,1] == "1", "Sim", tabela1[,1] )

tabela1<- as.data.frame(tabela1)

tabela1$variav<-c("N","Sexo(%)","",
                      "Diabetes mellitus (%)","","Hipertensão (%)",
                      "","Doença coração(%)","",
                      "Neoplasia (%)", "","Doença hepática (%)",
                      "","Doença vascular (%)", "",
                      "DPOC (%)", "", "Idade (mediana [IQR])")


tabela1<-data.frame(tabela1[,c(4,1,2,3)])

colnames(tabela1)<-c("Característica","", "Não óbito", "Óbito")

rownames(tabela1) <- NULL
```

```{r KMglobal, include=FALSE, echo = FALSE, message=FALSE, warning=FALSE}
#3. Estimacao nao parametrica - Kaplan-Meier global
#Status nao pode ser fator!
data$dead<-as.numeric(data$dead)

#Objeto surival
y <- survival::Surv(data$tempo, data$dead)

#Kaplan-Meier plot
plot1<- survfit2(y ~ 1, data = data) %>% 
  ggsurvfit() +
  labs(
    x = "Meses",
    y = "Probabilidade de sobrevivência"
  ) +
  add_confidence_interval() +
  add_risktable() +
  coord_cartesian(xlim = c(0, 60))

```

```{r mediana, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
#3.1 Mediana

#Probabilidde de sobreviver pelo menos 1, 2, ..., 8 meses
summary(survfit(y ~ 1, data = data), times = c(1:8))
#ou
#survfit(Surv(Time_to_Event, dead) ~ 1, data = data) %>% 
#  gtsummary::tbl_survfit(
#    times = c(1,2,3,4,5),
#    label_header = "**survival (95% CI)**"
# )

#Mediana = 2.24 anos (2.15,2.33)
survfit(Surv(tempo, dead) ~ 1, data = data)
```

```{r KMestrat, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE }
#4. Estimacao nao parametrica - Kaplan-Meier com estratificacao
#Kaplan-Meier plot - estratificado
#Sexo

splots <- list()
splots[[1]] <- ggsurvplot(survfit(y ~ Gender, data = data), data = data,conf.int=F, pval=TRUE, risk.table= FALSE, 
           legend.labs=c("F", "M"), legend.title="Sexo",  
           ggtheme = theme_minimal(),
           xlab = "Meses", ylab = "S(t)" , xlim= c(0,60), break.time.by = 20) 

#DM
splots[[2]] <- ggsurvplot(survfit(y ~ DM, data = data), data = data,conf.int=F, pval=TRUE, risk.table= FALSE, 
           legend.labs=c("Não", "Sim"), legend.title="Diabetes mellitus",  
           ggtheme = theme_minimal(),
           xlab = "Meses", ylab = "S(t)", xlim= c(0,60), break.time.by = 20) 

#Hipertensao
splots[[3]] <- ggsurvplot(survfit(y ~ hypert, data = data), data = data,conf.int=F, pval=TRUE, risk.table= FALSE, 
           legend.labs=c("Não", "Sim"), legend.title="Hipertensão",  
           ggtheme = theme_minimal(),
           xlab = "Meses", ylab = "S(t)", xlim= c(0,60), break.time.by = 20) 
#Coracao
splots[[4]] <- ggsurvplot(survfit(y ~ heart, data = data), data = data,conf.int=F, pval=TRUE, risk.table= FALSE, 
           legend.labs=c("Não", "Sim"), legend.title="Doença coração",  
           ggtheme = theme_minimal(),
           xlab = "Meses", ylab = "S(t)", xlim= c(0,60), break.time.by = 20) 

#Neoplasia
splots[[5]] <- ggsurvplot(survfit(y ~ neoplasia, data = data), data = data,conf.int=F, pval=TRUE, risk.table= FALSE, 
           legend.labs=c("Não", "Sim"), legend.title="Neoplasia",  
           ggtheme = theme_minimal(),
           xlab = "Meses", ylab = "S(t)", xlim= c(0,60), break.time.by = 20) 
 
#Figado
splots[[6]] <- ggsurvplot(survfit(y ~ liver, data = data), data = data,conf.int=F, pval=TRUE, risk.table= FALSE, 
           legend.labs=c("Não", "Sim"), legend.title="Doença hepática",  
           ggtheme = theme_minimal(),
           xlab = "Meses", ylab = "S(t)", xlim= c(0,60), break.time.by = 20) 

#Vascular
splots[[7]] <- ggsurvplot(survfit(y ~ vascular, data = data), data = data,conf.int=F, pval=TRUE, risk.table= FALSE, 
           legend.labs=c("Não", "Sim"), legend.title="Doença vascular",  
           ggtheme = theme_minimal(),
           xlab = "Meses", ylab = "S(t)", xlim= c(0,60), break.time.by = 20) 

#DPOC
splots[[8]] <- ggsurvplot(survfit(y ~ COPD, data = data), data = data,conf.int=F, pval=TRUE, risk.table= FALSE, 
           legend.labs=c("Não", "Sim"), legend.title="DPOC",  
           ggtheme = theme_minimal(),
           xlab = "Meses", ylab = "S(t)", xlim= c(0,60), break.time.by = 20) 

# Arrange multiple ggsurvplots and print the output

jpeg(file="KM_estrat.jpg", width = 15, height = 20, units = "cm", pointsize = 12,
     res = 600, quality = 85)
arrange_ggsurvplots(splots, print = TRUE, surv.plot.height = 0.9, ncol = 2, nrow = 4)
dev.off()
```

```{r logrank, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
#4.1 Comparando grupos - Log-rank
#Sexo
survdiff(y ~ Gender, data = data)
#Não há diferença 

#DM
survdiff(y ~ DM, data = data)
#Diferença significativa p= 0.04

#Hipertensao
survdiff(y ~ hypert, data = data)
#Diferença significativa p= <2e-16 

#Coraçao
survdiff(y ~ heart, data = data)
#Não há diferença 

#Neoplasia
survdiff(y ~ neoplasia, data = data)
#Não há diferença 

#Figado
survdiff(y ~ liver, data = data)
##Diferença significativa p= 0.01

#Vascular
survdiff(y ~ vascular, data = data)
#Não há diferença 

#DPOC
survdiff(y ~ COPD, data = data)
#Diferença significativa p= 8e-04

```

```{r peto, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
#4.2 Comparando grupos - Peto
#maior peso no incio do seguimento
#Sexo
survdiff(y ~ Gender, data = data, rho=1)
#Não há diferença 

#DM
survdiff(y ~ DM, data = data, rho=1)
#Diferença significativa p= 0.04

#Hipertensao
survdiff(y ~ hypert, data = data, rho=1)
#Diferença significativa p= <2e-16 

#Coraçao
survdiff(y ~ heart, data = data, rho=1)
#Não há diferença 

#Neoplasia
survdiff(y ~ neoplasia, data = data, rho=1)
#Não há diferença 

#Figado
survdiff(y ~ liver, data = data, rho=1)
##Diferença significativa p= 0.01

#Vascular
survdiff(y ~ vascular, data = data, rho=1)
#Não há diferença 

#DPOC
survdiff(y ~ COPD, data = data, rho=1)
#Diferença significativa p= 8e-04

```

```{r Cox_simples, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
#5. Modelos semi-parametricos simples - Cox
#Efeito isolado de cada covariavel sobre o tempo de sobrevivencia
#significancia p < 0.2

#Sexo
coxph(y ~ Gender, data = data) %>%
tbl_regression(exp = TRUE)
#nao signifitiva

#Idade
coxph(y ~ age10, data = data) %>%
tbl_regression(exp = TRUE) 
#nao signifitiva

#DM
coxph(y ~ DM, data = data) %>%
tbl_regression(exp = TRUE) 
#signifitiva

#hipertensao
coxph(y ~ hypert, data = data) %>%
tbl_regression(exp = TRUE) 
#signifitiva

#Coracao
coxph(y ~ heart, data = data) %>%
tbl_regression(exp = TRUE) 
#nao signifitiva

#Neoplasia
coxph(y ~ neoplasia, data = data) %>%
tbl_regression(exp = TRUE) 
#nao signifitiva

#Figado
coxph(y ~ liver, data = data) %>%
tbl_regression(exp = TRUE) 
#signifitiva

#Vascular
coxph(y ~ vascular, data = data) %>%
tbl_regression(exp = TRUE) 
#signifitiva p < 0.122

#DPOC
coxph(y ~ COPD, data = data) %>%
tbl_regression(exp = TRUE) 
#signifitiva

#os modelos de Cox simples confirmam a analise grafica e teste log-rak e peto
# As variaveis que ficam no modelo são Idade, DM, hipertensao, d. hepatica,
#vascular e DPOC

# Cox Proportional Hazards univariable analysis.
#Gerar a tabela com finalfit
explanatory = c("Gender", "DM", "hypert", "heart","neoplasia","liver",
                "vascular", "COPD", "age10")
dependent = "y"
data %>%
  coxphuni(dependent, explanatory) %>%
  fit2df() -> tabela2

names(tabela2) <- c("Variável", "Razão de riscos (IC 95%, valor-p)")
tabela2[,1] <- c("Sexo (M)","DM (Sim)","Hipertensão (Sim)", 
              "Doença do coração (Sim)", "Neoplasia (Sim)", 
              "Doença hepática (Sim)","Doença vascular (Sim)", "DPOC (Sim)",
              "Idade (década)")

```

```{r cox_multiplo, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
#6. Modelo semi-parametrico multiplo - Cox
#Efeitos ajustados das covariaveis sobre o tempo de sobrevivencia

mod0 <- coxph(y ~ 1, data = data, x = T)
#mod.saturado <- coxph(y ~ factor(ID), data = data) #nao rodar isso!

m1<- coxph(y ~ Gender + age10, x= TRUE, data = data) 
m2<- coxph(y ~ Gender + age10 + DM, x= TRUE, data = data) 
m3<- coxph(y ~ Gender + age10 + DM + hypert, x= TRUE, data = data) 
m4<- coxph(y ~ Gender + age10 + DM + hypert + liver, x= TRUE, data = data)
m5<- coxph(y ~ Gender + age10 + DM + hypert + liver + vascular, x= TRUE, 
           data = data)
m6<- coxph(y ~ Gender + age10 + DM + hypert + liver + vascular + COPD, 
           x= TRUE, data = data) 

anova1 <- anova(m1, m2, m3, m4, m5, m6)

tab3<-round(cbind.data.frame(anova1$loglik,anova1$`Pr(>|Chi|)`),4)
names(tab3) <- c('loglik', 'Pr(>|Chi|)')

summary(m6)
#Organizar a tabela pro relatorio

tab3 %>%
  select('loglik', 'Pr(>|Chi|)') %>%
  mutate(
    Modelo = c(1:6),
    Variaveis = c("Sexo+idade", "Sexo+idade+DM ", 
                  "Sexo+idade+DM+Hipertensão",
                  "Sexo+idade+DM+Hipertensão+D.hepática",
                  "Sexo+idade+DM+Hipertensão+D.hepática+D.vascular",
                  "Sexo+idade+DM+Hipertensão+D.hepática+D.vascular+DPOC" ),
    .before = loglik
      ) -> tabela3

linha1 <- c(0, "Nulo", round(logLik(mod0),4), NA)
tabela3 <- rbind(linha1,tabela3)
tabela3[4,4] <- "<0.001"
tabela3[6,4] <- "<0.001"
```

```{r res_mult, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
#6.1 Resultados do modelo ajustado

m6 %>%
tbl_regression(exp = TRUE) 

```

```{r prognostico, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
#6.2 Indice prognostico

source("Rfun.r")
jpeg(file="Concord_m6.jpg", width = 20, height = 20, units = "cm", pointsize = 12,
     res = 600, quality = 85)

par(mfrow = c(3,2))
plot.pi(m1, main = "Modelo 1", xlab = "Meses")
plot.pi(m2, main = "Modelo 2", xlab = "Meses")
plot.pi(m3, main = "Modelo 3", xlab = "Meses")
plot.pi(m4, main = "Modelo 4", xlab = "Meses")
plot.pi(m5, main = "Modelo 5", xlab = "Meses")
plot.pi(m6, main = "Modelo 6", xlab = "Meses")

dev.off()
```

```{r shoenfeld, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
#7.1 Analise de residuos

#Proporcionalidade - Shoenfeld
res.sho <- cox.zph(m6)

covar <- c("Beta (t) para Sexo","Beta (t) para Idade",
          "Beta (t) para DM","Beta (t) para Hipertensão", 
          "Beta (t) para Doença hepática","Beta (t) para Doença vascular", 
          "Beta (t) para DPOC")
              
jpeg(file = "Shoenfeld%2d.jpg")
for (k in 1:length(m6$coefficients)){
plot(res.sho[k], xlab = "Meses", col= c("red", "blue"), ylab = covar[k], 
     resid = FALSE, se= TRUE, lwd = 2)
abline(h=m6$coefficients[k], lty=4, col=2, lwd = 2)
}
dev.off()

res.sho

#outra opcao grafica
#ggcoxzph(res.sho, font.x = 10, font.y=10, main = "")
#Ref http://www.sthda.com/english/wiki/cox-model-assumptions

```

```{r mod_7, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
#constatada a nao proporcionalidade para hipertensao
#o modelo sera estratificado por essa variavel

m7<- coxph(y ~ Gender + age10 + DM + hypert + liver + vascular + COPD 
           + strata (hypert), 
           x= TRUE, data = data) 

summary(m7)
m7$loglik

#Coeficientes do modelo para equacao da regressao
coef_m7<-round(m7$coefficients,2)

#plot.pi(m7, main = "Modelo 7" )
#o indice prognistico nao funciona aqui

```

```{r shoenf_mod7, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}

res.sho7 <- cox.zph(m7)

covar2 <- c("Beta (t) para Sexo","Beta (t) para Idade",
          "Beta (t) para DM",
          "Beta (t) para Doença hepática","Beta (t) para Doença vascular", 
          "Beta (t) para DPOC")
              
jpeg(file = "Shoenf_m7%2d.jpg")
for (k in 1:length(m7$coefficients)){
plot(res.sho[k], xlab = "Meses", col= c("red", "blue"), ylab = covar[k], 
     resid = FALSE, se= TRUE)
abline(h=m7$coefficients[k], lty=4, col=2 )
}
dev.off()

res.sho7

```

```{r martingale, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}

#log-linearidade - Martingale

# Analisando a forma funcional através do gráfico dos resíduos de Martingale x idade
#grafico do residuo Martingale no modelo nulo x idade

mod0 <- coxph(y ~ 1, data = data, x = T)
summary(mod0)
mod0.mar <- resid(mod0, type= 'martingale')
plot (data$idade, mod0.mar, xlab = "Idade", ylab = "Resíduos martingale",
main= "Avaliação da
forma funcional da Idade", lwd=1, col= "grey" )
lines(lowess(data$idade, mod0.mar, iter = 0), lty = 2)
#Não há associação entre o tempo de sobrevivência e a idade, uma vez que não há 
#tendência linear e o lowess está em torno do zero.

#outra forma
ggcoxfunctional(Surv(Time_to_Event, dead) ~ age10, data = data,
                ggtheme = theme_minimal(),
                ylab = "Resíduos Martingale - modelo nulo",
                xlab = "Idade (década)"
                ) ->plot5

```

```{r rdeviance, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}

# atípicos - Residuos deviance
res.dev <-resid(m7, type = "deviance")
plot(res.dev, col= "grey", ylab = "Resíduos deviance", xlab = "Índice")
abline(h=0, col="red")

#Verifica-se grande quantidade de observacoes atipicas - 6.3%
(sum(res.dev  > 2) + sum(res.dev  < (-2)))/length(data$ID)

#outra forma
ggcoxdiagnostics(m7, type = "deviance",
                 linear.predictions = FALSE, sline = FALSE, ggtheme = theme_minimal(),
                 ylab = "Resíduos deviance",
                 xlab = "Índice", 
                 ) -> plot6

```

```{r rescore, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
#influentes - Residuos escore
res.esc <- resid(m7, type= 'dfbetas')

jpeg(file="escore.jpg", width = 15, height = 20, units = "cm", pointsize = 12,
     res = 600, quality = 85)
par(mfrow = c(3,2))
plot (data$Gender , res.esc[,1],xlab = "Sexo", ylab = "Resíduos escore", col = 0)
plot (data$age10 , res.esc[,2],xlab = "Idade (década)", ylab = "Resíduos escore")
plot (data$DM , res.esc[,3],xlab = "DM", ylab = "Resíduos escore",col = 0)
plot (data$liver , res.esc[,5],xlab = "Doença hepática", ylab = "Resíduos escore", col = 0)
plot (data$vascular , res.esc[,6],xlab = "Doença vascular", ylab = "Resíduos escore",col = 0)
plot (data$COPD , res.esc[,7],xlab = "DPOC", ylab = "Resíduos escore", col = 0)
dev.off()

#outra forma 

#jpeg(file="escore.jpg", width = 15, height = 20, units = "cm", pointsize = 12,
#     res = 600, quality = 85)
#ggcoxdiagnostics(m7, type = "dfbetas",
#                 linear.predictions = FALSE,
#                 sline = FALSE,
#                 ylab = "Resíduos dfbetas",
#                xlab = "Índice",
#                ggtheme = theme_minimal())
#dev.off()
```

```{r tab4, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
# Cox Proportional Hazards multivariable analysis
#strata - hypert

#Gerar a tabela com finalfit
explanatory2 = c("Gender","age10","DM","strata(hypert)",
                 "liver","vascular","COPD")
data %>%
  coxphmulti(dependent, explanatory2)%>%
  fit2df() -> tabela4

names(tabela4) <- c("Variável", "Razão de riscos (IC 95%, valor-p)")
tabela4[,1] <- c("Sexo (M)","Idade (década)","DM (Sim)",
              "Doença hepática (Sim)","Doença vascular (Sim)", 
              "DPOC (Sim)")
```

```{r forestplot, include= FALSE, echo = FALSE, message=FALSE, warning=FALSE}
exp_coef_m7<-exp(coef_m7)
d_forest <- exp(confint(m7))
d_forest <- round(d_forest[-4,],2)
dat <- data.frame(
  Index = c(1, 2, 3, 4,5,6), ## This provides an order to the data
  label = tabela4[,1],
  HR = exp_coef_m7[-4],
  LL = d_forest[,1],
  UL = d_forest[,2]
  
)

## Plot forest plot
plot8 <- ggplot(dat, aes(y = Index, x = HR)) +
  geom_point(shape = 18, size = 5) +  
  geom_errorbarh(aes(xmin = LL, xmax = UL), height = 0.25) +
  geom_vline(xintercept = 1, color = "red", linetype = "dashed", cex = 1, alpha = 0.5) +
  scale_y_continuous(name = "", breaks=1:6, labels = dat$label, trans = "reverse") +
  xlab("Razão de riscos (IC 95%)") + 
  ylab(" ") + 
  theme_bw() +
  theme(panel.border = element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"),
        axis.text.y = element_text(size = 12, colour = "black"),
        axis.text.x.bottom = element_text(size = 12, colour = "black"),
        axis.title.x = element_text(size = 12, colour = "black"))
plot8

```

# **1. Introdução**

A prevalência da doença renal crônica (DRC) em estágio terminal é alta em várias partes do mundo, com mais de um milhão de pessoas recebendo terapia renal substitutiva - TRS[@schena2000]. Esse estágio é caracterizado pela baixa e insuficiente capacidade funcional dos rins com taxa de filtração glomerular (GRF) \< 15 mL/min/1,73m^2^. Nessa fase da doença, o paciente passa a depender de alguma modalidade de TRS para sobreviver, sendo a diálise a mais comum[@nationalkidney; @sacarvalho2003].

A doença de base da DRC é fator prognóstico importante para os pacientes em TRS. Nesse sentido, o papel da Diabetes mellitus (DM) é amplamente conhecido na redução da sobrevida e o prognóstico é mais grave no caso de pacientes idosos [@schena2000]. O estágio terminal da DRC está se tornado uma condição geriátrica, o maior aumento da taxa de incidência ocorre em pacientes com idade entre 65 a 74 anos[@berger2012]. Assim, estudos com pacientes idosos em TRS devem levar em consideração a expectativa de vida restante do paciente, que usualmente é limitada pela presença de comorbidades, como diabetes, hipertensão, doença do coração e outras[@reindl-schwaighofer2017]. 
O objetivo desse trabalho foi investigar o efeito de comorbidades sobre o risco de óbito de pacientes com DRC em estágio terminal que iniciaram hemodiálise a partir dos 65 anos na Áustria.

# **2. Métodos**

Os dados analisados neste trabalho são provenientes de um estudo austríaco publicado na Revista PLoS ONE em 2017 intitulado "*Survival analysis of conservative vs. dialysis treatment of elderly patients with CKD stage 5* e encontram-se disponíveis na página eletrônica da revista [@reindl-schwaighofer2017; @raindl-schwaighofer2017]. Esses dados foram originalmente obtidos a partir do registro de diálise e transplante austríaco - *Austrian Dialysis and Transplant Registry (OEDTR)* - que identificou 8.622 pacientes incidentes de hemodiálise com idade igual o superior a 65 anos no período de janeiro de 2002 a dezembro de 2009. Essa coorte, construída de foma retrospectiva, teve tempo máximo de acompanhamento de cerca de 16 anos.

O desfecho no estudo é o tempo em meses desde o início da hemodiálise até o óbito ou fim do seguimento. As covariáveis analisadas se referem às comorbidades dos pacientes: Diabetes mellitus (DM), hipertensão arterial (HA), doença do coração, neoplasia, doença hepática, doença vascular e doença pulmonar obstrutiva crônica (DPOC). Tratam-se todas de variáveis dicotômicas, ou seja, estão presentes ou ausentes (sim e não) e não tempo-dependentes. Também foram analisados os efeitos da idade e do sexo sobre o tempo de sobrevivência.

Para estimar o efeito dessas covariáveis sobre o risco de óbito dos idosos em hemodiálise, foi ajustado um modelo de risco proporcionais de Cox que é definido como um modelo semiparamétrico, pois assume uma forma paramétrica para o efeito das covariáveis e uma não paramétrica para a função de risco basal [@shimakura2011].

Incialmente as covariáveis foram analisadas quanto à distribuição das frequências absolutas e relativas segundo o evento de interesse, óbito. Utilizou-se modelo não paramétrico de Kaplan-Meier para avaliar a sobrevida global dos pacientes e a sobrevida de acordo com a presença de cada comorbidade. O teste de log-rank ou Mantel Haenzel foi empregado para compraração formal das curvas adotando-se nível de significância de 5%. Essa análise inicial permite explorar o efeito das covariáveis sobre o tempo de sobrevivência em hemodiálise, bem como avaliar de modo preliminar a premissa de proporcionalidade dos riscos do modelo de Cox.

O processo de modelagem foi realizado basicamente em quatro etapas. Em primeiro lugar, foram obtidas as estimativas dos efeitos brutos de cada covariável sobre o tempo de sobrevivência dos pacientes com modelos de Cox simples. As variáveis candidatas ao modelo múltiplo foram aquelas que apresentaram significância ao nível de 20% (p-valor \<0,2) no teste de Wald para os coeficientes desses modelos.

Em seguida, o modelo de regressão de Cox foi elaborado comparando-se modelos aninhados com teste da razão de verossimilhança para verificar se a inclusão de uma covariável aumentava de modo significativo a verossimilhança do modelo maior em relação ao anterior, com menos variáveis (Anova tipo I). O nível de significância adototado foi de 5% (p-valor \<0,05). No primeiro modelo foram incluídas conjuntamente sexo e idade e nos subsequentes, cada uma das comorbidades que tiveram efeito signficativo nos modelos simples, uma a uma, sem ordem de importância definida por referencial teórico.

A qualidade de ajuste do modelo final foi avaliada segundo a estimativa da probabilidade de concordância estimada pelo modelo de Cox que é considerada comum em estudos de sobrevivência se o valor estiver entre 0,6 e 0,7 [@shimakura2011]. De forma complementar, foram elaborados gráficos de sobrevivência estratificados por índice prognóstico para análise do poder discriminatório do modelo.

Por fim, realizou-se análise gráfica dos resíduos de Schoenfeld para avaliar o pressuposto de proporcionalidde dos riscos de cada covariável do modelo de Cox. A violação desse pressuposto foi solucionada com a estratificação da variável hipertensão. A forma funcional da covariável quantitativa foi avaliada segundo gráfico dos resíduos Martingale do modelo nulo versus idade. Por fim, a presença de observações atípicas e influentes foi verificada mediante disposição gráfica dos resíduos *deviance* e escore respectivamente.

Os principais pacotes do software R v.4.1.2 ([http://www.r-project.org](http://www.r-project.org/)) utilizados neste trabalho foram: *survival*[@R-survival], *survminer*[@R-survminer] , *ggsurvfit* [@R-ggsurvfit] e *finalfit*[@R-finalfit].

# **3. Resultados**

Dos `r nrow(data)` pacientes que iniciaram tratamento com hemodiálise no período de 2002 a 2009 segundo registros austríacos, 53,8% eram do sexo masculino e a idade do grupo variou entre 65 e 99 anos, com mediana de 74 anos. A distribuição das comorbidades foi similar entre os casos de óbito e os sobreviventes, com exceção da hipertensão. 74,3% dos sobreviventes eram hipertensos, entre óbitos esse percentual foi de 56,8%. Na @tbl-Tabela1 verifica-se a distribuição das características dos idosos que iniciaram hemodiálise no período de janeiro de 2002 a dezembro de 2009.

\newpage

```{r Tabela1}
#| label: tbl-Tabela1
#| tbl-cap: "Características da coorte de idosos que iniciaram hemodiálise entre 2002 e 2009, segundo status (óbito) ao final do seguimento - Áustria, 2017"
#| warning: false
#| echo: false
#| message: false

kbl(tabela1, align = "lcccc") %>%
kable_classic(full_width = F) #%>%
#footnote(symbol = "DPOC: Doença pulmonar obstrutiva crônica")
```

A @fig-Figura1 ilustra a probabilidade de sobrevivência global dos pacientes que iniciaram hemodiálise. A mediana de sobrevivência dos pacientes incidentes em hemodiálise foi de 26,9 meses (IC 95%: 25,8;28,0).

Na sequência, os gráficos de Kaplan Meier estratificados ilustram o efeito de cada covariável e respectivos resultados dos testes log-rank (@fig-Figura2). Verifica-se maior diferença no comportameto das curvas para a variável hipertensão, o gráfico indica que a presença dessa comorbidade aumenta o tempo de sobrevivência dos pacientes. Diferenças significativas foram observadas para as covariáveis DM, hipertensão, doença hepática e DPOC, nesses casos rejeitamos a hipótese nula de que o risco é o mesmo para quem possui e quem não possui essas condições.

```{r Figura1, echo=FALSE, message=FALSE, warning=FALSE}
#| label: fig-Figura1
#| fig-cap: "Curva de sobrevivência global estimada pelo Kaplan-Meier dos pacientes em hemodiálise com intervalo de confiança de 95%."
#| out-width: "80%"
plot1

```

\newpage

```{r Figura2, echo=FALSE, message=FALSE, warning=FALSE, out.width="20cm",out.height="20cm" }
#| label: fig-Figura2
#| fig-cap: "Curvas de sobrevivência (Kaplan-Meier) dos pacientes em hemodiálise por variáveis analisadas"


knitr::include_graphics("KM_estrat.jpg", dpi=600)

```

\newpage

A @tbl-Tabela2 apresenta os efeitos de cada variável sobre o tempo de sobrevivência em hemodiálise com modelos de Cox simples. Dessa forma, as variáveeis elegíveis para o modelo múltiplo são idade, DM, hipertensão, doença hepática, doença vascular e DPOC (p-valor \< 0,2). No modelo univariado, o efeito da hipertensão é protetivo, ou seja, reduz o risco de óbito em 32%. De modo similar, a presença de DPOC reduz o risco de óbito de idosos em hemodiálise por unidade de tempo (mês) em 16%. Por outro lado, o efeito isolado da DM representa um aumento no risco de óbito de 6% na coorte e doença hepática aumenta esse risco em 16%.

A @tbl-Tabela3 apresenta a comparação dos modelos aninhados com teste da razão de verossimilhanças para para a seleção do modelo de Cox. Observa-se que inclusão de sucessiva das covariáveis resultou no aumento significativo da verossilhança (logik). A hipótese nula de que não há diferença entre os modelos foi rejeitada e o melhor modelo ajustado foi o 6 (sexo, idade, DM, hipertensão, doença hepática, doença vascular e DPOC). O Modelo 6 tem probabilidade de concordância de 0,6, indicando uma qualidade de ajuste considerada comum em análise de dados de sobrevivência.

```{r Tabela2}
#| label: tbl-Tabela2
#| tbl-cap: "Razão de riscos dos modelos simples de Cox com intervalos de confiança 95%"
#| warning: false
#| echo: false
#| message: false

kbl(tabela2, align = "lc") %>%
kable_classic(full_width = F) #%>%
#footnote(symbol = "DPOC: Doença pulmonar obstrutiva crônica"
#)

```

```{r Tabela3}
#| label: tbl-Tabela3
#| tbl-cap: "Funções de verossimilhança dos modelos de Cox para a seleção de modelo"
#| warning: false
#| echo: false
#| message: false
options(knitr.kable.NA = '-')
kbl(tabela3, align = "clcc", row.names = FALSE) %>%
kable_classic(full_width = F)

```

\newpage

Os gráficos de sobrevivência estratificados por índice prognóstico dos modelos mostram que os modelos 1 e 2 parecem discriminar melhor os grupos e ajustam-se bem (@fig-Figura3). Apesar da inclusão de variáveis melhorar a verossimilhança, o Modelo 6 apresenta as curvas do modelo e Kaplan-Meier mais distantes, mas ainda assim, discrimina de modo razoável os três grupos de índice prognóstico e foi mantido para análise de resíduos.

Na @fig-Figura4 observa-se pelas curvas de suavização *lowes* dos resíduos de Shoenfeld, como o efeito de cada covariável se comporta ao longo do tempo. Os resíduos não foram dispostos nos gráficos porque o número de observações não permite uma boa visualização dessas curvas. No caso da variável hipertensão,verifica-se claramente que o pressuposto de proporcionalide dos riscos não é atendido, pois há tendência linear ao longo dos meses, ou seja, quanto mais o tempo avança, maior o efeito da hipertensão sobre o risco de óbito em hemodiálise. No gráfico, a linha referente ao coeficiente do modelo (beta) extrapola o intervalo de confiança da curva. Nas demais variáveis observamos as retas que representam os coeficientes do modelo dentro dos intervalos de confiança com variações aleatórias ao longo do tempo, sem expressão notadamente linear.

```{r Figura3, echo=FALSE, message=FALSE, warning=FALSE, out.width="15cm",out.height="20cm"}
#| label: fig-Figura3
#| fig-cap: "Gráfico de sobrevivência estratificado por índice prognóstico para os modelos 1 a 6. Linha sólida representa o modelo ajustado e a linha pontilhada a estimativa de Kaplan-Meier"


knitr::include_graphics("Concord_m6.jpg", dpi = 600)

```

```{r Figura4, out.width="10%"}
#| echo: false
#| message: false
#| warning: false
#| label: fig-Figura4
#| fig-cap: "Curvas *lowes* dos resíduos de Shoenfeld para o Modelo 6."
#| fig-subcap: 
#|   - "Sexo"
#|   - "Idade"
#|   - "DM"
#|   - "Hipertensão"
#|   - "Doença hepática"
#|   - "Doença cardiovascular"
#|   - "DPOC"
#| layout-ncol: 3

Res_Sho<- c(paste0("Shoenfeld ", c(1:7), ".jpg"))

knitr::include_graphics(Res_Sho, dpi = 600)

```

Dessa forma, o Modelo 7 representado na equação abaixo, foi ajustado com estratificação pela covariável hipertensão:

$$
\lambda{j}(t|x)=\lambda_{0j}(t)exp(x\beta), j= 1,2
$$

onde $$ \lambda_{0j}(t) $$ representa o risco basal dos indivíduos com hipertensão (*j=1*) e sem hipertensão (*j=2*) e

$$
\beta = (0.06,0.36,0.21,0.21,0.13, -0.14),
$$ o vetor dos coeficientes do modelo para as covariáveis *x = (sexo masculino, idade, DM (sim), doença hepática (sim), doença vascular (sim), DPOC(sim))*, nesta ordem. Nesse modelo os coeficientes são os mesmos para hipertensos e normotensos, o que varia é o risco de base de acordo com esta condição.

Esse modelo teve a probabilidade de concordância reduzida em relação ao Modelo 6 (Concordância = 0,578). Os resíduos de Shoenfeld apresentaram comportamento similar aos do Modelo 6.

Na @fig-Figura5 confirmamos a adequação da forma funcional do Modelo 7, uma vez que a relação da variável idade em décadas com os resíduos martingale do modelo nulo é do tipo linear. Os resíduos *deviance* indicam uma quantidade considerável de pontos atípicos, totalizando 6,3% das observações do conjunto de dados(@fig-Figura6). O gráfico dos resíduos escore escalonados pelo erro padrão estão apresentados na @fig-Figura7. Observa-se uma escala bastante reduzida em todas as covariáveis, evidenciando a ausência pontos influentes.

```{r Figura5, echo=FALSE, message=FALSE, warning=FALSE}
#| label: fig-Figura5
#| fig-cap: "Idade (década) contra resíduos martingale do modelo nulo."
#| out-width: "70%"

#Martingale
plot5

```

```{r Figura6, echo=FALSE, message=FALSE, warning=FALSE}
#| label: fig-Figura6
#| fig-cap: "Resíduos *deviance* do Modelo 7."
#| out-width: "70%"

#Deviance
plot6

```

```{r Figura7, echo=FALSE, message=FALSE, warning=FALSE, out.width="15cm",out.height="20cm"}
#| label: fig-Figura7
#| fig-cap: "Resíduos escore do Modelo 7 (valor 1 no eixo horizontal indica a presença da comorbidade)."
#| out-width: "90%"

#Escore
knitr::include_graphics("escore.jpg", dpi = 600)

```

\newpage

As razões de riscos e respectivos intervalos de confiança a 95% obtidos com o Modelo 7 são apresentadas na @tbl-Tabela4 e e ilustradas na @fig-Figura8. Assim, nessa coorte, um paciente do sexo masculino em hemodiálise tem risco 6% maior de ir a óbito em cada unidade de tempo (mês) do que uma paciente do sexo feminino, ajustado pela idade e as outras comorbidades. A probabilidade de que o coeficiente do modelo de Cox para variável sexo seja igual a zero (hipótese nula) é muito baixa (p=0,022), ou seja, menor do que o nível de significância adotado. Ademais, o respectivo intervalo de confiança não engloba a unidade, indicando o efeito, embora pequeno, mas signiticativo do sexo sobre o risco de morte em hemodiálise. Também temos um efeito significativo da idade, cada década representa um aumento de 43% no risco de óbito, controlado pelas demais variáveis do modelo. Verifica-se que ter Diabetes mellitus aumenta o risco de óbito do paciente em hemodiálise em 24% em relação a não ter, também ajustado por idade, sexo e outras comorbidades. A presença de doença hepática também aumenta o risco de óbito em 24% comparada ao risco na ausência dessa condição, ajustado pelas demais covariáveis. A doença vascular aumenta o risco de óbito em hemodiálise em 13%, controlado pelas demais variáveis. Por fim, nessa coorte, o paciente com DPOC possui um risco menor de óbito que o paciente sem DPOC, quando ajustado pelas outras covariáveis do modelo. Ainda sobre o efeito das comorbidades, o maior intervalo de confiança da razão de riscos foi observado para doença hepática que possui menor prevalência na coorte analisada.

```{r Tabela4}
#| label: tbl-Tabela4
#| tbl-cap: "Razão de riscos com intervalos de confiança 95% do modelo de Cox estratificado pela variável hipertensão"
#| warning: false
#| echo: false
#| message: false

kbl(tabela4, align = "lc") %>%
kable_classic(full_width = F) %>%
footnote(symbol = "loglik: -41799.24")

```

```{r Figura8, echo=FALSE, message=FALSE, warning=FALSE}
#| label: fig-Figura8
#| fig-cap: "Razão de riscos com intervalos de confiança de 95% do modelo de Cox estratificado pela variável hipertensão."
#| out-width: "70%"

plot8

```

\newpage

# **4. Discussão**

A taxa de mortalidade de pacientes em terapia renal substitutiva é fortemente influenciada pela condição de base da doença renal crônica, pela idade e comorbidades[@sacarvalho2003]. O presente trabalho buscou dimensionar o efeito de determinadas comborbidades, sobre o risco de óbito de pacientes idosos que iniciaram hemodiálise na Áustria entre 2002 e 2009.

No artigo orginal foram vericados efeitos significativos sobre a mortalidade para as seguintes variáveis: idade, sexo, DPOC, Diabetes mellitus, doença do coração, hipertensão, doença hepática e doença vascular[@reindl-schwaighofer2017]. Em nosso caso, doença cardíaca não foi detectada como significativa, pois foi excluída no primeiro critério de seleção de variáveis (modelo simples com p-valor \> 0,2). Tratam-se de abordagens distintas, pois o trabalho original contemplava dados de mais 174 pacientes que realizavam tratamento conservador para a DRC terminal com utilização de escore de propensão para balancear os grupos de comparação. Entende-se que além disso, a diferença nos efeitos se deve às estratégias de seleção de modelos adotatadas. A variável hipertensão constava no modelo final apresentado pelos autores indicando efeito protetor para a sobrevida, no entanto, o artigo original não faz referência à análise dos pressupostos do modelo de Cox. Em nosso estudo essa variável foi agregada ao risco basal do modelo e assim, não foi possível analisar seu efeito. A magnitude dos efeitos das comorbidades foi similar nos dois estudos para os pacientes em hemodiálise, com exceção da doença hepática que foi menor no estudo original(1,12 IC 95%: 1,13-1,27)[@reindl-schwaighofer2017].

A validade do modelo proposto foi confirmada pela análise dos resíduos (Shoenfeld, martingale, *deviance* e escore), no entanto, a qualidade do ajuste é baixa, pois não se obteve poder discriminatório satisfatório. Além dissso, outra importante limitação do trabalho se deve à ausência de informação sobre a doença de base da DRC, pois esta afeta de modo importante o prognóstico dos pacientes. Dentre as variáveis analisadas, sabe-se que ambas, DM e hipertensão, são fatores de risco para o surgimento e progressão da DRC[@vanwalraven2014; @berger2012] e aqui foram consideradas exclusivamente como comorbidades. Outro ponto é o fato de não termos considerado o efeito de possíveis interações, pois a coexistência de dois ou mais fatores pode significar um risco maior de óbito, com efeito superior ao conjunto dos efeitos independentes (sinergia). De todo modo,verifica-se que não há alterações relevantes entre efeitos brutos e ajustados, não há mudança de direção do efeito em nenhuma das covariáveis do modelo. Isto reduz a possibilidade de interação entre variáveis.

Para definir com maior rigor as covariáveis do modelo seria necessário estabelecer um referencial teórico detalhado sobre as condições que realmente afetam o prognóstico de pacientes idosos em hemodiálise. Aqui foram analisadas todas as comorbidades presentes no banco de dados e não foi definida ordem de importância para a entrada das variáveis no modelo de Cox. De antemão havia apenas a informação de que de que a Diabetes mellitus reduz a sobrevida e de prognóstico mais grave em idosos[@schena2000].

Por fim, apesar de não serem desenhados com a finalidade de realização de estudos epidemiológicos e por vezes serem limitados quanto à qualidade da informação, os registros administrativos são bastante úteis para a compreensão dos processos de saúde e doença. Neste caso, o sistema de registros de TRS austríaco propiciou uma coorte de 8.622 idosos em hemodiálise, algo difícil de se conseguir em um estudo prospectivo. Para além dos efeitos das comorbidades, idade e sexo, os resultados desta análise também refletem o contexo de cuidado e atenção oferecida aos pacientes em hemodiálise naquele país.

# **5. Informações adicionais**

O código criado para realização deste trabalho, assim como o banco de dados e artigo original encontram-se disponíveis no endereço: <https://github.com/karlaferrer/IAS>.

# **6. Referências**
